# Alfresco Docker Stack

> Generated by `alf-cli` for ACS 25.2

This stack provides a **minimal Alfresco Content Services Repository** with Solr configured for content and audit indexing. Keep this README next to your `compose.yaml`.

## Quick start

```bash
# from this folder
docker compose up -d
docker compose ps
```

To watch logs:

```bash
docker compose logs -f --tail=200
```

To stop:

```bash
docker compose down
```

> **Tip:** First startup can take several minutes while images are pulled and indexes initialize.

## Selected configuration

* **ACS version:** `25.2`
* **Protocol:** `http`
* **Host:** `localhost`
* **HTTP port:** `8080`
* **FTP:** disabled
* **Database:** PostgreSQL
* **Search (Solr):**
  * Cross-locale: enabled
  * Content indexing: enabled
  * Audit indexing: enabled (via `SearchAudit.xml`)
  * Communication: secret
* **Events (ActiveMQ):** embedded broker
* **Add-ons:** none (folders for AMPs/JARs are included)
* **Volumes:** managed by Docker (named volumes)

## Credentials

* **Repository (admin):** `admin` / *(password entered during generation)*

  > Change it after first login.

> Database credentials are defined in `compose.yaml` environment variables for the DB service.

## Endpoints

Base URL: `http://localhost:8080`

* **Alfresco Repository API:**
  `http://localhost:8080/alfresco/`

> **Solr:** not exposed outside the Docker network. Admin UI is reachable from inside the network at `http://solr6:8983/solr/`.

## How to run

1. **Start services**

   ```bash
   docker compose up -d
   ```

2. **Wait until Repository is live**

   ```bash
   curl -sf "http://localhost:8080/alfresco/api/-default-/public/alfresco/versions/1/probes/-live-" && echo "Repository is live"
   ```

3. **Log in** at `http://localhost:8080/alfresco/` with `admin` / *(your password)*.

## How to test

### 1) Verify discovery

```bash
curl -u admin:YOUR_PASSWORD \
  http://localhost:8080/alfresco/api/-default-/public/alfresco/versions/1/discovery | jq .
```

### 2) Upload a document

```bash
curl -u admin:YOUR_PASSWORD -F filedata=@README.md \
  -F name="readme.md" -F nodeType="cm:content" \
  http://localhost:8080/alfresco/api/-default-/public/alfresco/versions/1/nodes/-my-/children
```

### 3) Full-text search

Create `search.json`:

```json
{
  "query": { "query": "name:readme OR text:readme" },
  "paging": { "maxItems": 10, "skipCount": 0 }
}
```

Run:

```bash
curl -u admin:YOUR_PASSWORD -H "Content-Type: application/json" -d @search.json \
  http://localhost:8080/alfresco/api/-default-/public/search/versions/1/search | jq .
```

> Cross-locale search is enabled. Mixed-language content will be tokenized accordingly.

## Project structure

The `alfresco/` service folder contains:

```
alfresco/
├── Dockerfile              # Custom Docker build for the Repository service
├── config/
│   └── SearchAudit.xml     # Enables audit indexing for Solr
└── modules/
    ├── amps/               # Place Alfresco Repository AMPs here
    │   └── empty
    └── jars/               # Place Alfresco Repository JARs here
        └── empty
```

### Customization

* **Audit indexing:**
  Modify `alfresco/config/SearchAudit.xml` to adapt audit indexing rules.

* **Add-ons:**
  Drop your AMPs into `alfresco/modules/amps/` or JARs into `alfresco/modules/jars/`.
  Then rebuild and restart:

  ```bash
  docker compose build --no-cache alfresco
  docker compose up -d
  ```

## Database

* Engine: PostgreSQL (5432)
* Host (inside Docker network): `postgres`
* Credentials: see `compose.yaml` environment of the DB service.

CLI example (from the host):

```bash
docker compose exec postgres psql -U $POSTGRES_USER -c '\l'
```

## Events (ActiveMQ)

Using an embedded broker (no extra service exposed). No configuration needed.

## HTTPS

HTTPS is disabled. To enable later, re-run the generator with HTTPS enabled or adapt `config/nginx.conf` and expose 443 in `compose.yaml`.

## Maintenance

* **Update images**

  ```bash
  docker compose pull
  docker compose up -d
  ```

* **Backups**

  ```bash
  docker run --rm -v <VOLUME_NAME>:/data -v "$PWD":/backup alpine tar czf /backup/<VOLUME_NAME>.tgz -C / data
  ```

* **Reset the stack (DANGER)**

  ```bash
  docker compose down -v
  ```

## Troubleshooting

* **Ports in use:** change `8080` in `compose.yaml`.
* **Low memory/CPU:** increase Docker resources; first startup is heavier due to indexing.
* **Search returns no results yet:** wait for indexing to complete, then retry.
* **Database connection issues:** ensure the DB container is healthy (`docker compose ps`), check env vars.

---

*For more info, visit [alf-cli](https://github.com/aborroy/alf-cli).*
